<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="${document.title + ' - STEMIND'}">Chi tiết tài liệu - STEMIND</title>
    <link rel="icon" type="image/png" th:href="@{/images/Symbol.png}">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">

    <!-- CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link th:href="@{/style/base/base1.css}" rel="stylesheet">
    <link th:href="@{/style/base/base2.css}" rel="stylesheet">
    <link th:href="@{/style/base/header.css}" rel="stylesheet">
    <link th:href="@{/style/home/detail.css}" rel="stylesheet">
</head>

<body class="d-flex flex-column min-vh-100">
    <!-- Header -->
    <div th:replace="~{base/header :: header}"></div>

    <!-- Main Content -->
    <main id="main-content" class="flex-grow-1 page-transition">
        <!-- Toast Notifications Container -->
        <div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
            <div th:if="${message}" class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header" th:classappend="${messageType == 'success'} ? 'bg-success text-white' : 'bg-danger text-white'">
                    <i class="fas" th:classappend="${messageType == 'success'} ? 'fa-check-circle' : 'fa-exclamation-triangle'"></i>
                    <strong class="me-auto" th:text="${messageType == 'success'} ? 'Thành công' : 'Lỗi'"></strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body" th:text="${message}"></div>
            </div>
        </div>

        <!-- Document Hero Section -->
        <section class="document-hero">
            <div class="container">
                <div class="document-hero-content">
                    <!-- Breadcrumb -->
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb breadcrumb-custom">
                            <li class="breadcrumb-item"><a th:href="@{/}">Trang chủ</a></li>
                            <li class="breadcrumb-item"><a th:href="@{/search}">Tài liệu</a></li>
                            <li class="breadcrumb-item active" aria-current="page" th:text="${#strings.abbreviate(document.title, 30)}">Tài liệu</li>
                        </ol>
                    </nav>
                    
                    <!-- Document Title & Info -->
                    <div class="row align-items-start">
                        <div class="col-lg-8">
                            <h1 class="display-5 fw-bold mb-3" th:text="${document.title}">Tiêu đề tài liệu</h1>
                            <p class="lead mb-4" th:text="${document.description}" th:if="${document.description != null and !#strings.isEmpty(document.description)}">Mô tả tài liệu...</p>
                        </div>
                        <div class="col-lg-4">
                            <div class="document-meta">
                                <div class="document-meta-item">
                                    <i class="fas fa-user text-primary"></i>
                                    <span><strong>Người chia sẻ:</strong> <span th:text="${document.authorName != null ? document.authorName : 'Anonymous'}">Người chia sẻ</span></span>
                                </div>
                                <div class="document-meta-item">
                                    <i class="fas fa-calendar text-success"></i>
                                    <span><strong>Ngày tạo:</strong> <span th:text="${document.createdAt != null ? #temporals.format(document.createdAt, 'dd/MM/yyyy') : 'Không xác định'}">Không xác định</span></span>
                                </div>
                                <div class="document-meta-item">
                                    <i class="fas fa-tag text-warning"></i>
                                    <span><strong>Danh mục:</strong> <span class="badge bg-primary" th:text="${document.category}">Category</span></span>
                                </div>
                                <div class="document-meta-item" th:if="${document.courseName != null}">
                                    <i class="fas fa-book text-info"></i>
                                    <span><strong>Môn học:</strong> <span th:text="${document.courseName}">Môn học</span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Document Content Section -->
        <section class="document-content-section">
            <div class="container">
                <div class="row g-4">
                    <!-- Main Content -->
                    <div class="col-lg-8">
                        <!-- File Preview/Download Section -->
                        <div class="file-preview-card">
                            <div class="file-preview-header">
                                <h4 class="mb-0">
                                    <i class="fas fa-eye me-2"></i>Xem trước tài liệu
                                </h4>
                                <div class="file-type-badge" th:if="${document.fileUrl != null and !#strings.isEmpty(document.fileUrl)}">
                                    <span class="badge bg-primary" th:text="${document.fileUrl != null and document.fileUrl.contains('.') ? #strings.toUpperCase(document.fileUrl.substring(document.fileUrl.lastIndexOf('.') + 1)) : 'FILE'}">FILE</span>
                                </div>
                                <div class="file-type-badge" th:if="${document.fileUrl == null or #strings.isEmpty(document.fileUrl)}">
                                    <span class="badge bg-secondary">UNKNOWN</span>
                                </div>
                            </div>
                            
                            <div class="file-preview-body" th:if="${document.fileUrl != null and !#strings.isEmpty(document.fileUrl)}">
                                <!-- PDF Viewer -->
                                <div class="pdf-viewer" th:if="${document.fileUrl != null and document.fileUrl.toLowerCase().endsWith('.pdf')}">
                                    <iframe th:src="${document.fileUrl}" 
                                            style="width: 100%; height: 600px; border: none;"
                                            loading="lazy">
                                        <p>Trình duyệt của bạn không hỗ trợ hiển thị PDF. 
                                           <a th:href="${document.fileUrl}" target="_blank">Nhấp vào đây để tải file</a>
                                        </p>
                                    </iframe>
                                </div>
                                
                                <!-- Image Viewer -->
                                <div class="image-viewer" th:if="${document.fileUrl != null and (
                                                                   document.fileUrl.toLowerCase().endsWith('.jpg') or 
                                                                   document.fileUrl.toLowerCase().endsWith('.jpeg') or 
                                                                   document.fileUrl.toLowerCase().endsWith('.png') or 
                                                                   document.fileUrl.toLowerCase().endsWith('.gif') or 
                                                                   document.fileUrl.toLowerCase().endsWith('.bmp') or 
                                                                   document.fileUrl.toLowerCase().endsWith('.webp'))}">
                                    <img th:src="${document.fileUrl}" 
                                         th:alt="${document.title}" 
                                         class="img-fluid"
                                         style="max-width: 100%; height: auto; max-height: 600px; object-fit: contain;">
                                </div>
                                
                                <!-- Text File Viewer -->
                                <div class="text-viewer" th:if="${document.fileUrl != null and (
                                                                  document.fileUrl.toLowerCase().endsWith('.txt') or 
                                                                  document.fileUrl.toLowerCase().endsWith('.md') or 
                                                                  document.fileUrl.toLowerCase().endsWith('.html') or 
                                                                  document.fileUrl.toLowerCase().endsWith('.css') or 
                                                                  document.fileUrl.toLowerCase().endsWith('.js') or 
                                                                  document.fileUrl.toLowerCase().endsWith('.json') or 
                                                                  document.fileUrl.toLowerCase().endsWith('.xml'))}">
                                    <iframe th:src="${document.fileUrl}" 
                                            style="width: 100%; height: 600px; border: none; background: white;"
                                            loading="lazy">
                                        <p>Không thể hiển thị file văn bản. 
                                           <a th:href="${document.fileUrl}" target="_blank">Nhấp vào đây để xem file</a>
                                        </p>
                                    </iframe>
                                </div>
                                
                                <!-- Office Documents Viewer (Word, Excel, PowerPoint) -->
                                <div class="office-viewer" th:if="${document.fileUrl != null and (
                                                                   document.fileUrl.toLowerCase().endsWith('.doc') or 
                                                                   document.fileUrl.toLowerCase().endsWith('.docx') or 
                                                                   document.fileUrl.toLowerCase().endsWith('.xls') or 
                                                                   document.fileUrl.toLowerCase().endsWith('.xlsx') or 
                                                                   document.fileUrl.toLowerCase().endsWith('.ppt') or 
                                                                   document.fileUrl.toLowerCase().endsWith('.pptx'))}">
                                    <div class="text-center py-5">
                                        <i class="fas fa-file-word fa-5x text-primary mb-3" th:if="${document.fileUrl != null and (document.fileUrl.toLowerCase().endsWith('.doc') or document.fileUrl.toLowerCase().endsWith('.docx'))}"></i>
                                        <i class="fas fa-file-excel fa-5x text-success mb-3" th:if="${document.fileUrl != null and (document.fileUrl.toLowerCase().endsWith('.xls') or document.fileUrl.toLowerCase().endsWith('.xlsx'))}"></i>
                                        <i class="fas fa-file-powerpoint fa-5x text-warning mb-3" th:if="${document.fileUrl != null and (document.fileUrl.toLowerCase().endsWith('.ppt') or document.fileUrl.toLowerCase().endsWith('.pptx'))}"></i>
                                        
                                        <h5 class="mb-3" th:text="${document.title}">Tên tài liệu</h5>
                                        <p class="text-muted mb-4">
                                            <i class="fas fa-info-circle me-2"></i>
                                            Định dạng: <span th:text="${document.fileUrl != null and document.fileUrl.contains('.') ? #strings.toUpperCase(document.fileUrl.substring(document.fileUrl.lastIndexOf('.') + 1)) : 'FILE'}">FILE</span>
                                        </p>
                                        
                                        <div class="alert alert-info" role="alert">
                                            <i class="fas fa-lightbulb me-2"></i>
                                            File Office cần được tải xuống để xem. Nhấp vào nút bên dưới để tải file.
                                        </div>
                                        
                                        <!-- Online Office Viewer Option -->
                                        <div class="mb-3">
                                            <a th:href="'https://view.officeapps.live.com/op/embed.aspx?src=' + ${document.fileUrl}" 
                                               target="_blank" 
                                               class="btn btn-info btn-lg me-2">
                                                <i class="fas fa-eye me-2"></i>Xem Online (Office)
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Generic File Viewer for other formats -->
                                <div class="generic-viewer" th:if="${document.fileUrl != null and !(
                                                                       document.fileUrl.toLowerCase().endsWith('.pdf') or 
                                                                       document.fileUrl.toLowerCase().endsWith('.jpg') or 
                                                                       document.fileUrl.toLowerCase().endsWith('.jpeg') or 
                                                                       document.fileUrl.toLowerCase().endsWith('.png') or 
                                                                       document.fileUrl.toLowerCase().endsWith('.gif') or 
                                                                       document.fileUrl.toLowerCase().endsWith('.bmp') or 
                                                                       document.fileUrl.toLowerCase().endsWith('.webp') or 
                                                                       document.fileUrl.toLowerCase().endsWith('.txt') or 
                                                                       document.fileUrl.toLowerCase().endsWith('.md') or 
                                                                       document.fileUrl.toLowerCase().endsWith('.html') or 
                                                                       document.fileUrl.toLowerCase().endsWith('.css') or 
                                                                       document.fileUrl.toLowerCase().endsWith('.js') or 
                                                                       document.fileUrl.toLowerCase().endsWith('.json') or 
                                                                       document.fileUrl.toLowerCase().endsWith('.xml') or 
                                                                       document.fileUrl.toLowerCase().endsWith('.doc') or 
                                                                       document.fileUrl.toLowerCase().endsWith('.docx') or 
                                                                       document.fileUrl.toLowerCase().endsWith('.xls') or 
                                                                       document.fileUrl.toLowerCase().endsWith('.xlsx') or 
                                                                       document.fileUrl.toLowerCase().endsWith('.ppt') or 
                                                                       document.fileUrl.toLowerCase().endsWith('.pptx'))}">
                                    <div class="text-center py-5">
                                        <i class="fas fa-file-alt fa-5x text-primary mb-3"></i>
                                        <h5 class="mb-3" th:text="${document.title}">Tên tài liệu</h5>
                                        <p class="text-muted mb-4">
                                            <i class="fas fa-info-circle me-2"></i>
                                            Định dạng: <span th:text="${document.fileUrl != null and document.fileUrl.contains('.') ? #strings.toUpperCase(document.fileUrl.substring(document.fileUrl.lastIndexOf('.') + 1)) : 'FILE'}">FILE</span>
                                        </p>
                                        
                                        <div class="alert alert-warning" role="alert">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            Loại file này không hỗ trợ xem trước trực tiếp. Vui lòng tải xuống để xem.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- File Actions -->
                            <div class="file-actions" th:if="${document.fileUrl != null and !#strings.isEmpty(document.fileUrl)}">
                                <div class="actions-grid w-100">
                                    <div class="action-col action-40">
                                        <a id="downloadBtn"
                                           th:href="${document.fileUrl}"
                                           class="btn btn-primary btn-lg w-100"
                                           target="_blank"
                                           download
                                           th:attr="data-document-id=${document.documentId},data-file-url=${document.fileUrl}">
                                            <i class="fas fa-download me-2"></i>
                                            Tải xuống
                                            <span id="downloadCount" class="badge bg-light text-dark rounded-pill ms-2 count-badge"
                                                  th:text="${document.downloadCount != null ? document.downloadCount : 0}">0</span>
                                        </a>
                                    </div>
                                    <div class="action-col action-40">
                                        <button id="likeBtn"
                                                class="btn btn-lg w-100"
                                                th:classappend="${liked} ? 'btn-danger' : 'btn-outline-danger'"
                                                th:attr="data-document-id=${document.documentId},data-user-id=${currentUserId},data-liked=${liked}">
                                            <i class="me-2"
                                               th:class="${liked} ? 'fas fa-heart' : 'far fa-heart'"></i>
                                            <span id="likeLabel" th:text="${liked} ? 'Bỏ yêu thích' : 'Yêu thích'">Yêu thích</span>
                                            <span id="likeCount" class="badge bg-danger rounded-pill ms-2 count-badge"
                                                  th:text="${document.favoriteCount != null ? document.favoriteCount : 0}">0</span>
                                        </button>
                                    </div>
                                    <div class="action-col action-20">
                                        <button class="btn btn-outline-primary btn-lg w-100" onclick="shareDocument()">
                                            <i class="fas fa-share-alt me-2"></i>Chia sẻ
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- No File Available Message -->
                            <div class="file-preview-body text-center py-5" th:if="${document.fileUrl == null or #strings.isEmpty(document.fileUrl)}">
                                <div class="alert alert-warning" role="alert">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Không thể xem trước:</strong> File không có sẵn hoặc đường dẫn không hợp lệ.
                                </div>
                                <a href="#" class="btn btn-outline-primary btn-lg disabled">
                                    <i class="fas fa-download me-2"></i>Tải xuống không khả dụng
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div class="col-lg-4">
                        <!-- Comments -->
                        <div class="sidebar-card mb-4">
                            <div class="sidebar-card-header">
                                <i class="fas fa-comments me-2"></i>Bình luận
                            </div>
                            <div class="sidebar-card-body">
                                <!-- Comment form (only when logged in) -->
                                <form id="commentForm" class="mb-3" th:if="${currentUserId != null}"
                                      th:attr="data-document-id=${document.documentId},data-user-id=${currentUserId}">
                                    <div class="mb-2">
                                        <textarea id="commentInput" class="form-control" rows="3" placeholder="Viết bình luận..."></textarea>
                                    </div>
                                    <div class="text-end">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-paper-plane me-2"></i>Gửi
                                        </button>
                                    </div>
                                </form>

                                <!-- Comments list -->
                                <ul id="commentsList" class="list-unstyled mb-0" th:if="${!#lists.isEmpty(lastComment)}">
                                    <li class="comment-item" th:each="c : ${lastComment}">
                                        <div class="comment-avatar">C</div>
                                        <div class="comment-content">
                                            <div th:text="${c.content}">Nội dung bình luận</div>
                                            <small th:text="${#temporals.format(c.createAt, 'dd/MM/yyyy hh:mm:ss')}">Thời gian</small>
                                        </div>
                                    </li>
                                </ul>
                                <div id="commentsEmpty" class="text-muted text-center" th:if="${#lists.isEmpty(lastComment)}">Chưa có bình luận. Hãy là người đầu tiên!</div>
                            </div>
                        </div>

                        

                        <!-- Related Documents -->
                        <div class="sidebar-card">
                            <div class="sidebar-card-header">
                                <i class="fas fa-link me-2"></i>
                                Tài liệu liên quan
                            </div>
                            <div class="sidebar-card-body">
                                <ul class="list-group list-group-flush" th:if="${!#lists.isEmpty(relativeDocument)}">
                                    <li class="list-group-item px-0" th:each="doc : ${relativeDocument}">
                                        <a class="d-flex align-items-start text-decoration-none" th:href="@{/document/detail/{id}(id=${doc.documentId})}">
                                            <i class="fas fa-file-alt text-secondary me-2 mt-1"></i>
                                            <span class="text-truncate d-inline-block" style="max-width: 260px;" th:text="${doc.title}">Tên tài liệu</span>
                                        </a>
                                    </li>
                                </ul>
                                <p class="text-muted text-center mb-0" th:if="${#lists.isEmpty(relativeDocument)}">Chưa có tài liệu liên quan</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <div th:replace="~{base/footer :: footer}"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/script/base/base.js}"></script>
    <script th:src="@{/script/base/footer.js}"></script>
    <script th:src="@{/script/home/detail.js}"></script>

    <script>
    // Auto-hide toast notifications after 5 seconds
    document.addEventListener('DOMContentLoaded', function() {
        const toasts = document.querySelectorAll('.toast');
        toasts.forEach(function(toast) {
            setTimeout(function() {
                toast.classList.add('hide');
                setTimeout(function() {
                    toast.remove();
                }, 300);
            }, 5000);
        });
    });

    // Document actions
    function toggleFavorite() {
        // Legacy placeholder removed; handled by detail.js now
        alert('');
    }

    function shareDocument() {
        if (navigator.share) {
            navigator.share({
                title: document.title,
                url: window.location.href
            });
        } else {
            // Fallback: copy to clipboard
            navigator.clipboard.writeText(window.location.href).then(() => {
                alert('Link đã được sao chép vào clipboard!');
            });
        }
    }

    function reportDocument() {
        // TODO: Implement report functionality
        alert('Chức năng báo cáo sẽ được triển khai sau');
    }

    // Post comment to backend and refresh page on success
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('commentForm');
        if (!form) return;
        const input = document.getElementById('commentInput');

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const content = (input.value || '').trim();
            if (!content) return;

            const documentId = form.getAttribute('data-document-id');
            const userId = form.getAttribute('data-user-id');

            // Disable submit button to prevent double submission
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang gửi...';

            try {
                const res = await fetch('/comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ documentId, userId, content })
                });

                if (!res.ok) throw new Error('Post comment failed');

                // Refresh the page to show the new comment
                window.location.reload();

            } catch (err) {
                alert('Không gửi được bình luận. Vui lòng thử lại.');
                // Re-enable submit button on error
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Gửi';
            }
        });
    });
    </script>
</body>
</html>
